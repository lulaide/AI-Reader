<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>文章阅读器</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      margin: 0;
      height: 100vh;
    }
    #sidebar {
      width: 300px;
      border-right: 1px solid #ccc;
      padding: 20px;
      overflow-y: auto;
    }
    #main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }
    red {
      background-color: #ffd2d2;
      padding: 0 2px;
      border-radius: 2px;
    }
    green {
      background-color: #d2ffd2;
      padding: 0 2px;
      border-radius: 2px;
    }
    #article-content {
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .article-item {
      cursor: pointer;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .article-item:hover, .article-item.active {
      background-color: #f0f0f0;
    }
    #ask-container {
        margin-top: 20px;
    }
    #answer {
        margin-top: 10px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>文章列表</h2>
    <div id="article-list"></div>
    <hr>
    <h3>添加新文章</h3>
    <input type="text" id="url-input" placeholder="输入文章 URL" style="width: 90%;">
    <button onclick="addArticle()">添加</button>
  </div>
  <div id="main-content">
    <h1 id="title"></h1>
    <div id="article-content"></div>
    <div id="ask-container">
        <h3>提问</h3>
        <input type="text" id="question-input" placeholder="输入你的问题" style="width: 80%;">
        <button onclick="askQuestion()">提问</button>
        <div id="answer"></div>
    </div>
  </div>

  <script>
    let articles = [];
    let activeArticleIndex = -1;

    async function fetchArticles() {
      const response = await fetch('/api/articles');
      articles = await response.json();
      renderArticleList();
      if (articles.length > 0) {
        displayArticle(0);
      }
    }

    function renderArticleList() {
      const listElement = document.getElementById('article-list');
      listElement.innerHTML = '';
      articles.forEach((article, index) => {
        const item = document.createElement('div');
        item.className = 'article-item';
        if (index === activeArticleIndex) {
            item.classList.add('active');
        }
        item.textContent = article.title;
        item.onclick = () => displayArticle(index);
        listElement.appendChild(item);
      });
    }

    function displayArticle(index) {
        activeArticleIndex = index;
        const article = articles[index];
        document.getElementById('title').innerText = article.title;
        document.getElementById('article-content').innerHTML = article.content;
        document.getElementById('answer').innerHTML = '';
        document.getElementById('question-input').value = '';
        renderArticleList();
    }

    async function addArticle() {
        const urlInput = document.getElementById('url-input');
        const url = urlInput.value;
        if (!url) return;
        
        const response = await fetch('/api/article', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url })
        });

        if (response.ok) {
            urlInput.value = '';
            await fetchArticles();
        } else {
            const error = await response.json();
            alert(`Error: ${error.error}`);
        }
    }

    async function askQuestion() {
        const questionInput = document.getElementById('question-input');
        const question = questionInput.value;
        if (!question || activeArticleIndex === -1) return;

        const response = await fetch('/api/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ question, index: activeArticleIndex })
        });
        
        const data = await response.json();
        const answerDiv = document.getElementById('answer');
        if (response.ok) {
            answerDiv.innerText = data.answer;
        } else {
            answerDiv.innerText = `Error: ${data.error}`;
        }
    }

    window.onload = fetchArticles;
  </script>
</body>
</html>
